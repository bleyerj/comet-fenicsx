
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Linear viscoelasticity with JAX &#8212; Computational Mechanics Numerical Tours with FEniCSx</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=e2c50d4c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tours/nonlinear_problems/linear_viscoelasticity_jax/linear_viscoelasticity_jax';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Localized 1D solutions in phase-field approach to brittle fracture" href="../bound_constrained/bound_constrained.html" />
    <link rel="prev" title="Elasto-plastic analysis of a 2D von Mises material" href="../plasticity/plasticity.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/logo.png" class="logo__image only-light" alt="Computational Mechanics Numerical Tours with FEniCSx - Home"/>
    <script>document.write(`<img src="../../../_static/logo.png" class="logo__image only-dark" alt="Computational Mechanics Numerical Tours with FEniCSx - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    Welcome
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../intro/linear_elasticity/linear_elasticity.html">Linear elasticity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/hyperelasticity/hyperelasticity.html">Hyperelasticity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/plates/plates.html">Reissner-Mindlin plates</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tours</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../linear_problems/contents.html">Linear problems</a><input checked class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../linear_problems/isotropic_orthotropic_elasticity/isotropic_orthotropic_elasticity.html">Isotropic and orthotropic plane stress elasticity <span class="far fa-star"></span></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../linear_problems/axisymmetric_elasticity/axisymmetric_elasticity.html">Axisymmetric formulation for elastic structures of revolution <span class="far fa-star"></span></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../linear_problems/thermoelasticity_weak/thermoelasticity_weak.html">Linear thermoelasticity (weak coupling) <span class="far fa-star"></span></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../linear_problems/thermoelasticity_full/thermoelasticity_full.html">Thermo-elastic evolution problem (full coupling) <span class="far fa-star"></span><span class="far fa-star"></span></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../dynamics/contents.html">Dynamics problems</a><input checked class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../dynamics/elastodynamics_newmark/elastodynamics_newmark.html">Transient elastodynamics with Newmark time-integration <span class="far fa-star"></span><span class="far fa-star"></span></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../plates/contents.html">Plates</a><input checked class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../plates/reissner_mindlin_quads/reissner_mindlin_quads.html">Shear-locking in thick plate models with quadrilateral elements  <span class="far fa-star"></span></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../shells/contents.html">Shells</a><input checked class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../shells/linear_shell/linear_shell.html">Linear shell model <span class="far fa-star"></span><span class="far fa-star"></span></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../shells/I_beam_gmsh/I_beam_gmsh.html">Generating a shell model with the <code class="docutils literal notranslate"><span class="pre">Gmsh</span></code> Python API <span class="far fa-star"></span></a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../contents.html">Nonlinear problems</a><input checked class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../plasticity/plasticity.html">Elasto-plastic analysis of a 2D von Mises material <span class="far fa-star"></span><span class="far fa-star"></span><span class="far fa-star"></span></a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Linear viscoelasticity with JAX <span class="far fa-star"></span><span class="far fa-star"></span><span class="far fa-star"></span></a></li>
<li class="toctree-l2"><a class="reference internal" href="../bound_constrained/bound_constrained.html">Localized 1D solutions in phase-field approach to brittle fracture <span class="far fa-star"></span><span class="far fa-star"></span></a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tips and tricks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../tips/mark_facets/mark_facets.html">Marking facets with geometrical functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tips/import_msh/import_msh.html">Importing a <code class="docutils literal notranslate"><span class="pre">.msh</span></code> file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tips/piecewise_constant_field/piecewise_constant_field.html">Create a piecewise constant field for spatially varying properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tips/mass_lumping/mass_lumping.html">Lumping a mass matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tips/quadrature_schemes/quadrature_schemes.html">Quadrature schemes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tips/computing_reactions/computing_reactions.html">Computing consistent reaction forces</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/bleyerj/comet-fenicsx" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/bleyerj/comet-fenicsx/edit/main/tours/nonlinear_problems/linear_viscoelasticity_jax/linear_viscoelasticity_jax.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Linear viscoelasticity with JAX </h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nonlinear-constitutive-models-in-fenics">Nonlinear constitutive models in FEniCS</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#automation-and-high-performance-computation-using-jax">Automation and high-performance computation using JAX</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-viscoelastic-behavior">Linear viscoelastic behavior</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-rheological-formulation">1D rheological formulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-generalization">3D generalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-integration">Time-integration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-position">Problem position</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quadrature-functions">Quadrature functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-implementation-of-the-constitutive-equation">JAX implementation of the constitutive equation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#local-material-constitutive-behavior">Local material constitutive behavior</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tangent-operator-with-automatic-differentiation">Tangent operator with Automatic Differentiation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jit-and-automatic-vectorization">JIT and automatic vectorization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dolfinx-constitutive-update"><code class="docutils literal notranslate"><span class="pre">dolfinx</span></code> constitutive update</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-newton-solver">Custom Newton solver</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-stepping-loop">Time-stepping loop</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="linear-viscoelasticity-with-jax">
<h1>Linear viscoelasticity with JAX <span class="far fa-star"></span><span class="far fa-star"></span><span class="far fa-star"></span><a class="headerlink" href="#linear-viscoelasticity-with-jax" title="Link to this heading">#</a></h1>
<div class="objectives admonition">
<p class="admonition-title">Objectives</p>
<p>This demo shows how to implement a nonlinear constitutive model, specifically a linear viscoelastic behavior. We rely on a manual Python-based implementation of the constitutive update at each quadrature point. To improve computational efficiency of evaluating a Python function while looping over all quadrature points, we leverage Just-In-Time compilation and automatic vectorization provided by the <a class="reference external" href="https://jax.readthedocs.io">JAX library</a>. In addition, consistent tangent operator are automatically derived using JAX Automatic Differentiation.
<span class="math notranslate nohighlight">\(\newcommand{\bsig}{\boldsymbol{\sigma}}
\newcommand{\beps}{\boldsymbol{\varepsilon}}
\newcommand{\bepsv}{\boldsymbol{\varepsilon}^\text{v}}
\newcommand{\epsv}{\varepsilon^\text{v}}
\newcommand{\sigv}{\sigma^\text{v}}
\newcommand{\bv}{\boldsymbol{v}}
\newcommand{\bI}{\boldsymbol{I}}
\newcommand{\CC}{\mathbb{C}}
\newcommand{\bT}{\boldsymbol{T}}
\newcommand{\dOm}{\,\text{d}\Omega}
\newcommand{\dS}{\,\text{d}S}
\newcommand{\dt}{\,\text{d}t}
\newcommand{\Neumann}{{\partial \Omega_\text{N}}}
\newcommand{\Dirichlet}{{\partial \Omega_\text{D}}}\)</span></p>
</div>
<a class="reference internal image-reference" href="../../../_images/jax_framework.png"><img alt="../../../_images/jax_framework.png" class="align-center" src="../../../_images/jax_framework.png" style="width: 600px;" /></a>
<div class="download admonition">
<p class="admonition-title">Download sources</p>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../../../_downloads/44e5105cf6ecc861747f88477ba6b877/linear_viscoelasticity_jax.py"><code class="xref download docutils literal notranslate"><span class="pre">Python</span> <span class="pre">script</span></code></a></p></li>
<li><p><a class="reference download internal" download="" href="../../../_downloads/b6c612bbbaedb23ee624a281d3a0fc53/linear_viscoelasticity_jax.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Jupyter</span> <span class="pre">notebook</span></code></a></p></li>
<li><p><a class="reference download internal" download="" href="../../../_downloads/2b61a76bd131e28625422b63f5a7db82/linear_viscoelasticity_jax.zip"><code class="xref download docutils literal notranslate"><span class="pre">Complete</span> <span class="pre">sources</span> <span class="pre">files</span></code></a></p></li>
</ul>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For more details about JAX-based implementation of constitutive equations, we refer to Andrey’s Latyshev work at <a class="github reference external" href="https://github.com/a-latyshev/dolfinx-external-operator">a-latyshev/dolfinx-external-operator</a>.</p>
</div>
<section id="nonlinear-constitutive-models-in-fenics">
<h2>Nonlinear constitutive models in FEniCS<a class="headerlink" href="#nonlinear-constitutive-models-in-fenics" title="Link to this heading">#</a></h2>
<p>Although this tour considers <strong>linear</strong> viscoelasticity, we will treat the problem as involving a general nonlinear constitutive behavior. The latter will be implemented explicitly using Python, mimicking a generic black-box material library. In this case, the stress <span class="math notranslate nohighlight">\(\bsig\)</span> is evaluated as a nonlinear function of the total strain <span class="math notranslate nohighlight">\(\beps\)</span>, yielding the following nonlinear variational problem:</p>
<div class="math notranslate nohighlight" id="equation-nonlinear-variational-model">
<span class="eqno">(26)<a class="headerlink" href="#equation-nonlinear-variational-model" title="Link to this equation">#</a></span>\[\int_{\Omega} \bsig(\beps):\nabla^s \bv \dOm = \int_\Omega \boldsymbol{f}\cdot\bv \dOm + \int_{\partial \Omega_\text{N}} \bT\cdot\bv \dS \quad \forall\bv \in V\]</div>
<p>Viscoelasticity involves solving for the time evolution of internal viscous strains <span class="math notranslate nohighlight">\(\bepsv\)</span>. The constitutive relation is therefore implicitly defined via the evolution of this internal state variable. We collect in the set <span class="math notranslate nohighlight">\(\mathcal{S}_n\)</span> the state of the material at time <span class="math notranslate nohighlight">\(t_n\)</span>, here we have <span class="math notranslate nohighlight">\(\mathcal{S}_n = \{\bepsv_n\}\)</span>. The evaluation of the constitutive equation will be strain-driven in the sense that we provide a total strain increment <span class="math notranslate nohighlight">\(\Delta \beps\)</span> and the previous state at time <span class="math notranslate nohighlight">\(t_n\)</span> and the role of the constitutive model is to compute the new stress <span class="math notranslate nohighlight">\(\bsig_{n+1}\)</span> and the new state <span class="math notranslate nohighlight">\(\mathcal{S}_{n+1}\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-constitutive-black-box">
<span class="eqno">(27)<a class="headerlink" href="#equation-constitutive-black-box" title="Link to this equation">#</a></span>\[\beps=\beps_n+\Delta\beps, \mathcal{S}_n \longrightarrow \boxed{\text{CONSTITUTIVE RELATION}}\longrightarrow \bsig_{n+1}, \mathcal{S}_{n+1}\]</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>In the legacy FEniCS tour on <a class="reference external" href="https://comet-fenics.readthedocs.io/en/latest/demo/viscoelasticity/linear_viscoelasticity.html">Linear Viscoelasticity</a>, we relied on a mixed formulation discretizing both the displacement and viscous strains at the structure level which was solved in a monolithic fashion. In the present approach, we voluntarily depart from this choice to focus on the implementation of a user-defined constitutive model.</p>
</div>
<section id="automation-and-high-performance-computation-using-jax">
<h3>Automation and high-performance computation using JAX<a class="headerlink" href="#automation-and-high-performance-computation-using-jax" title="Link to this heading">#</a></h3>
<p>The present approach will involve looping over all quadrature points to evaluate the constitutive behavior locally. This approach is obviously computationally inefficient due to the Python loop. To solve this issue, we will rely on the <a class="reference external" href="https://jax.readthedocs.io">JAX library</a>.</p>
<p><img alt="" src="https://jax.readthedocs.io/en/latest/_static/jax_logo_250px.png" /></p>
<p>JAX is a Python library for accelerated (GPU) array computation and program transformation, designed for high-performance numerical computing and large-scale machine learning. Its key features of interest here involve:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://jax.readthedocs.io/en/latest/jax-101/01-jax-basics.html">Accelerated <code class="docutils literal notranslate"><span class="pre">numpy</span></code>/<code class="docutils literal notranslate"><span class="pre">scipy</span></code> functions</a></p></li>
<li><p><a class="reference external" href="https://jax.readthedocs.io/en/latest/jax-101/04-advanced-autodiff.html">Automatic Differentiation</a>, see also the <a class="reference external" href="https://jax.readthedocs.io/en/latest/notebooks/autodiff_cookbook.html">AutoDiff Cookbook</a></p></li>
<li><p><a class="reference external" href="https://jax.readthedocs.io/en/latest/jax-101/02-jitting.html">Just-In-Time compilation</a> using <code class="docutils literal notranslate"><span class="pre">jax.jit</span></code></p></li>
<li><p><a class="reference external" href="https://jax.readthedocs.io/en/latest/jax-101/03-vectorization.html">Automatic Vectorization</a> using <code class="docutils literal notranslate"><span class="pre">jax.vmap</span></code></p></li>
</ul>
</section>
</section>
<section id="linear-viscoelastic-behavior">
<h2>Linear viscoelastic behavior<a class="headerlink" href="#linear-viscoelastic-behavior" title="Link to this heading">#</a></h2>
<p>In this numerical tour, we consider a simple linear viscoelastic behavior, the Standard Linear Solid model, which encompasses the case of a Maxwell and a Kelvin-Voigt model. The formulation can also be quite easily extended to a generalized Maxwell model.</p>
<section id="d-rheological-formulation">
<h3>1D rheological formulation<a class="headerlink" href="#d-rheological-formulation" title="Link to this heading">#</a></h3>
<p>The Linear Standard Solid model consists of a spring of stiffness <span class="math notranslate nohighlight">\(E_0\)</span> in parallel to a Maxwell arm (spring of stiffness <span class="math notranslate nohighlight">\(E_1\)</span> in series with a dashpot of viscosity <span class="math notranslate nohighlight">\(\eta_1\)</span>).</p>
<a class="reference internal image-reference" href="../../../_images/1D_rheological_model.png"><img alt="../../../_images/1D_rheological_model.png" class="align-center" src="../../../_images/1D_rheological_model.png" style="width: 300px;" /></a>
<p>The uniaxial stress for this rheological model can be decomposed as the sum of a reversible and an irreversible stress:</p>
<div class="math notranslate nohighlight">
\[\sigma = E_0\varepsilon + E_1(\varepsilon-\epsv)\]</div>
<p>whereas the evolution equation for the viscous internal strain is given by:</p>
<div class="math notranslate nohighlight">
\[\dot{\varepsilon}^\text{v} = \dfrac{E_1}{\eta_1}(\varepsilon-\epsv)\]</div>
<p>Introducing <span class="math notranslate nohighlight">\(\tau=\eta_1/E_1\)</span> the characteristic relaxation time, the viscous strain evolution equation can be written as:</p>
<div class="math notranslate nohighlight" id="equation-viscous-strain-evolution">
<span class="eqno">(28)<a class="headerlink" href="#equation-viscous-strain-evolution" title="Link to this equation">#</a></span>\[\dot{\varepsilon}^\text{v} + \dfrac{1}{\tau}\epsv = \dfrac{1}{\tau}\varepsilon\]</div>
<p>or, equivalently, in terms of the viscous stress <span class="math notranslate nohighlight">\(\sigv = E_1(\varepsilon-\epsv)\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-viscous-stress-evolution">
<span class="eqno">(29)<a class="headerlink" href="#equation-viscous-stress-evolution" title="Link to this equation">#</a></span>\[\dot{\sigma}^\text{v} + \dfrac{1}{\tau}\sigv = E_1\dot{\varepsilon}\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The extension to a generalized Maxwell model with <span class="math notranslate nohighlight">\(N\)</span> internal strains is given by:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\sigma &amp;= E_0\varepsilon + \sum_{i=1}^N E_i(\varepsilon-\varepsilon^{\text{v},i}) \\
\dot{\varepsilon}^{\text{v},i} &amp;= \dfrac{E_i}{\eta_i}(\varepsilon-\varepsilon^{\text{v},i}) \quad \forall i=1,\ldots, N
\end{align*}\]</div>
</div>
</section>
<section id="d-generalization">
<h3>3D generalization<a class="headerlink" href="#d-generalization" title="Link to this heading">#</a></h3>
<p>For the 3D case, isotropic viscoelasticity is characterized by two elastic moduli (resp. two viscosities, or equivalently two relaxation times) for each spring (resp. dashpot) element of the 1D model. Here, we will restrict to a simpler case in which one modulus is common to all elements (similar Poisson ratio for all elements), that is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
\boldsymbol{\sigma} = E_0\mathbb{c}:\boldsymbol{\varepsilon} + E_1\mathbb{c}:(\boldsymbol{\varepsilon}-\bepsv) \\
\dot{\boldsymbol{\varepsilon}}^\text{v} = \dfrac{E_1}{\eta_1}\mathbb{c}:(\boldsymbol{\varepsilon}-\bepsv)
\end{align}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbb{c} = \dfrac{\nu}{1-\nu^2}\mathbf{1}\otimes\mathbf{1} + \dfrac{1}{1+\nu}\mathbb{I}\)</span> for plane stress with <span class="math notranslate nohighlight">\(\mathbf{1}\)</span> and <span class="math notranslate nohighlight">\(\mathbb{I}\)</span> being respectively the 2nd and 4th order identity tensors and <span class="math notranslate nohighlight">\(\nu\)</span> being the Poisson ratio.</p>
</section>
<section id="time-integration">
<h3>Time-integration<a class="headerlink" href="#time-integration" title="Link to this heading">#</a></h3>
<p>There exist many possible choices of discrete time integration for the linear viscoelastic evolution equations, see <span id="id1">[<a class="reference internal" href="#id12" title="Joonas Sorvari and Jari Hämäläinen. Time integration in linear viscoelasticity—a comparative study. Mechanics of Time-Dependent Materials, 14:307–328, 2010.">Sorvari and Hämäläinen, 2010</a>]</span> for a review. In the following, we choose a semi-analytical method which considers the exact solution of the ODE <a class="reference internal" href="#equation-viscous-stress-evolution">(29)</a> between time <span class="math notranslate nohighlight">\(t_n\)</span> and <span class="math notranslate nohighlight">\(t_{n+1}=t_n+\Delta t\)</span>:</p>
<div class="math notranslate nohighlight">
\[
\sigv(t_{n+1}) = e^{-\Delta t/\tau}\sigv(t_n) + E_1\int_{t_n}^{t_{n+1}}e^{-(t_{n+1}-t)/\tau}\dot\varepsilon(t)\dt
\]</div>
<p>When approximating the right-hand side integral using a mid-point rule and a constant strain increment one obtains:</p>
<div class="math notranslate nohighlight">
\[\sigv(t_{n+1}) = e^{-\Delta t/\tau}\sigv(t_n) + E_1e^{-\Delta t/(2\tau)}\Delta\varepsilon\]</div>
<p>or, in terms of the viscous strain:</p>
<div class="math notranslate nohighlight" id="equation-incremental-evol-equation">
<span class="eqno">(30)<a class="headerlink" href="#equation-incremental-evol-equation" title="Link to this equation">#</a></span>\[\epsv_{n+1} = \varepsilon_{n+1}+e^{-\Delta t/\tau}(\epsv_n-\varepsilon_n) - e^{-\Delta t/(2\tau)}(\varepsilon_{n+1}-\varepsilon_{n})\]</div>
</section>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
<section id="problem-position">
<h3>Problem position<a class="headerlink" href="#problem-position" title="Link to this heading">#</a></h3>
<p>We consider here a 2D rectangular domain of dimensions <span class="math notranslate nohighlight">\(L\times H\)</span>.</p>
<p>We first load the relevant modules and define the geometry and the displacement function space. For later use, we configure JAX to work with double-precision floats rather than the default single precision.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">import</span> <span class="nn">basix</span>
<span class="kn">from</span> <span class="nn">dolfinx</span> <span class="kn">import</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">fem</span><span class="p">,</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">dolfinx.common</span> <span class="kn">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">solvers</span> <span class="kn">import</span> <span class="n">CustomLinearProblem</span><span class="p">,</span> <span class="n">CustomNewtonSolver</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># use double-precision</span>

<span class="n">length</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">domain</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">create_rectangle</span><span class="p">(</span>
    <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span>
    <span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">height</span><span class="p">)),</span>
    <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
    <span class="n">ghost_mode</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">GhostMode</span><span class="o">.</span><span class="n">none</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">gdim</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dim</span>

<span class="n">deg_u</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdim</span><span class="p">,)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">deg_u</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Material properties corresponding to <span class="math notranslate nohighlight">\(E_0=70\)</span> GPa, <span class="math notranslate nohighlight">\(\nu=0.3\)</span>, <span class="math notranslate nohighlight">\(\eta_1=1\)</span> GPa.s and <span class="math notranslate nohighlight">\(\tau=0.05\)</span> s are now defined and stored in a dictionary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mat_prop</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;YoungModulus&quot;</span><span class="p">:</span> <span class="mf">70e3</span><span class="p">,</span> <span class="s2">&quot;PoissonRatio&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The boundary conditions consist of symmetry planes on <span class="math notranslate nohighlight">\(x=0\)</span> and <span class="math notranslate nohighlight">\(y=0\)</span> and smooth contact with a plane with imposed vertical displacement on <span class="math notranslate nohighlight">\(y=H\)</span>. The solution will therefore be homogeneous in the sample. We impose a constant vertical relaxation strain state <span class="math notranslate nohighlight">\(\varepsilon_r=10^{-3}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">V_ux</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>
<span class="n">V_uy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>
<span class="n">left_dofs</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_geometrical</span><span class="p">(</span>
    <span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">V_ux</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">bot_dofs</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_geometrical</span><span class="p">(</span>
    <span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">V_uy</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">top_dofs</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_geometrical</span><span class="p">(</span>
    <span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">V_uy</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">height</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">uD_x0</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_ux</span><span class="p">)</span>
<span class="n">uD_y0</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_uy</span><span class="p">)</span>
<span class="n">uD_y</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_uy</span><span class="p">)</span>
<span class="n">epsr</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">uD_y</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">epsr</span> <span class="o">*</span> <span class="n">height</span><span class="p">)</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">uD_x0</span><span class="p">,</span> <span class="n">left_dofs</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
    <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">uD_y0</span><span class="p">,</span> <span class="n">bot_dofs</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">uD_y</span><span class="p">,</span> <span class="n">top_dofs</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="quadrature-functions">
<h3>Quadrature functions<a class="headerlink" href="#quadrature-functions" title="Link to this heading">#</a></h3>
<p>Similarly to the <a class="reference internal" href="../plasticity/plasticity.html"><span class="std std-doc">Elasto-plastic analysis of a 2D von Mises material </span></a> tour, we use <code class="docutils literal notranslate"><span class="pre">Quadrature</span></code> function spaces to define the stress and tangent operator to be used in the nonlinear variational formulation. We will also keep track of the viscous strain internal state variable in the same fashion. Since we work in 2D, we use a vectorial representation for the tensorial quantities consisting of the <span class="math notranslate nohighlight">\(xx\)</span>, <span class="math notranslate nohighlight">\(yy\)</span>, and <span class="math notranslate nohighlight">\(xy\)</span> components using the Mandel notation, see <a class="reference internal" href="../../linear_problems/isotropic_orthotropic_elasticity/isotropic_orthotropic_elasticity.html"><span class="std std-doc">Isotropic and orthotropic plane stress elasticity </span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">deg_quad</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># quadrature degree for internal state variable representation</span>
<span class="n">vdim</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># dimension of the vectorial representation of tensors</span>
<span class="n">W0e</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FiniteElement</span><span class="p">(</span>
    <span class="s2">&quot;Quadrature&quot;</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span>
    <span class="n">degree</span><span class="o">=</span><span class="n">deg_quad</span><span class="p">,</span>
    <span class="n">quad_scheme</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">We</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span>
    <span class="s2">&quot;Quadrature&quot;</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span>
    <span class="n">degree</span><span class="o">=</span><span class="n">deg_quad</span><span class="p">,</span>
    <span class="n">dim</span><span class="o">=</span><span class="n">vdim</span><span class="p">,</span>
    <span class="n">quad_scheme</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">WTe</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TensorElement</span><span class="p">(</span>
    <span class="s2">&quot;Quadrature&quot;</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span>
    <span class="n">degree</span><span class="o">=</span><span class="n">deg_quad</span><span class="p">,</span>
    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">vdim</span><span class="p">,</span> <span class="n">vdim</span><span class="p">),</span>
    <span class="n">quad_scheme</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">We</span><span class="p">)</span>
<span class="n">WT</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">WTe</span><span class="p">)</span>
<span class="n">W0</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">W0e</span><span class="p">)</span>


<span class="n">sig</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Stress&quot;</span><span class="p">)</span>
<span class="n">Ct</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">WT</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Tangent_operator&quot;</span><span class="p">)</span>
<span class="n">epsv</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Viscous_strain&quot;</span><span class="p">)</span>
<span class="n">epsv_old</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Previous_viscous_strain&quot;</span><span class="p">)</span>
<span class="n">eps_old</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Previous_total_strain&quot;</span><span class="p">)</span>

<span class="n">u</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Total_displacement&quot;</span><span class="p">)</span>
<span class="n">du</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Iteration_correction&quot;</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">u_</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We now define the nonlinear residual and associated tangent bilinear form of the corresponding problem. Note that since the stress <code class="docutils literal notranslate"><span class="pre">sig</span></code> is stored as a vector, we use the Mandel representation for defining the (virtual) strain</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eps_Mandel</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>


<span class="n">dx</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span>
    <span class="s2">&quot;dx&quot;</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;quadrature_degree&quot;</span><span class="p">:</span> <span class="n">deg_quad</span><span class="p">,</span> <span class="s2">&quot;quadrature_scheme&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">Residual</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eps_Mandel</span><span class="p">(</span><span class="n">u_</span><span class="p">),</span> <span class="n">sig</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">tangent_form</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eps_Mandel</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ct</span><span class="p">,</span> <span class="n">eps_Mandel</span><span class="p">(</span><span class="n">u_</span><span class="p">)))</span> <span class="o">*</span> <span class="n">dx</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we extract the total number of quadrature points and define the <code class="docutils literal notranslate"><span class="pre">fem.Expression</span></code> corresponding to the total strain <code class="docutils literal notranslate"><span class="pre">esp_Mandel(u)</span></code> to perform the evaluation at all quadrature points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">basix_celltype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">basix</span><span class="o">.</span><span class="n">CellType</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">cell_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">quadrature_points</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">make_quadrature</span><span class="p">(</span><span class="n">basix_celltype</span><span class="p">,</span> <span class="n">deg_quad</span><span class="p">)</span>

<span class="n">map_c</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">index_map</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
<span class="n">num_cells</span> <span class="o">=</span> <span class="n">map_c</span><span class="o">.</span><span class="n">size_local</span> <span class="o">+</span> <span class="n">map_c</span><span class="o">.</span><span class="n">num_ghosts</span>
<span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">ngauss</span> <span class="o">=</span> <span class="n">num_cells</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

<span class="n">eps_expr</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">eps_Mandel</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">quadrature_points</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">eval_at_quadrature_points</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">expression</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">cells</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ngauss</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="jax-implementation-of-the-constitutive-equation">
<h3>JAX implementation of the constitutive equation<a class="headerlink" href="#jax-implementation-of-the-constitutive-equation" title="Link to this heading">#</a></h3>
<section id="local-material-constitutive-behavior">
<h4>Local material constitutive behavior<a class="headerlink" href="#local-material-constitutive-behavior" title="Link to this heading">#</a></h4>
<p>We are now ready to define the material constitutive equation at a single quadrature point. We define a function taking as arguments the total strain increment <span class="math notranslate nohighlight">\(\Delta \beps\)</span> (<code class="docutils literal notranslate"><span class="pre">deps</span></code>), the total <span class="math notranslate nohighlight">\(\beps_n\)</span> (<code class="docutils literal notranslate"><span class="pre">eps_old</span></code>) and viscous <span class="math notranslate nohighlight">\(\bepsv_n\)</span> (<code class="docutils literal notranslate"><span class="pre">epsv_old</span></code>) strains at the previous time step and the time increment <span class="math notranslate nohighlight">\(\Delta t\)</span> (<code class="docutils literal notranslate"><span class="pre">dt</span></code>). Strain-like quantities are here of shape <code class="docutils literal notranslate"><span class="pre">(3,)</span></code>. The function simply implements the incremental approximate evolution equation <a class="reference internal" href="#equation-incremental-evol-equation">(30)</a>. The function returns the new stress and new state of the material.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">local_constitutive_update</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="n">eps_old</span><span class="p">,</span> <span class="n">epsv_old</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">eps_old</span> <span class="o">+</span> <span class="n">deps</span>

    <span class="n">E0</span> <span class="o">=</span> <span class="n">mat_prop</span><span class="p">[</span><span class="s2">&quot;YoungModulus&quot;</span><span class="p">]</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">mat_prop</span><span class="p">[</span><span class="s2">&quot;PoissonRatio&quot;</span><span class="p">]</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">mat_prop</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">]</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">mat_prop</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span>
    <span class="n">E1</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">/</span> <span class="n">tau</span>

    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nu</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">nu</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nu</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span>
    <span class="n">C0</span> <span class="o">=</span> <span class="n">E0</span> <span class="o">*</span> <span class="n">c</span>
    <span class="n">C1</span> <span class="o">=</span> <span class="n">E1</span> <span class="o">*</span> <span class="n">c</span>

    <span class="n">epsv</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">eps</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">epsv_old</span> <span class="o">-</span> <span class="n">eps_old</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">deps</span>
    <span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">C0</span> <span class="o">@</span> <span class="n">eps</span> <span class="o">+</span> <span class="n">C1</span> <span class="o">@</span> <span class="p">(</span><span class="n">eps</span> <span class="o">-</span> <span class="n">epsv</span><span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">epsv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sig</span><span class="p">,</span> <span class="n">state</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="tangent-operator-with-automatic-differentiation">
<h4>Tangent operator with Automatic Differentiation<a class="headerlink" href="#tangent-operator-with-automatic-differentiation" title="Link to this heading">#</a></h4>
<p>The constitutive equation should also return the algorithmic tangent operator <span class="math notranslate nohighlight">\(\mathbf{C}_\text{tang} = \dfrac{\text{d} \bsig}{\text{d}\beps}\)</span>. Although the latter is extremely easy to compute in the present case, we show how to use JAX’s Automatic Differentiation capabilities to derive it automatically. We rely on the <code class="docutils literal notranslate"><span class="pre">jax.jacfwd</span></code> function which computes the jacobian of the <code class="docutils literal notranslate"><span class="pre">local_constitutive_update</span></code> function with respect to argument <code class="docutils literal notranslate"><span class="pre">argnums=0</span></code>, namely <span class="math notranslate nohighlight">\(\Delta \beps\)</span> here. The computation is done using forward-mode automatic differentiation, although here the tangent operator is of square shape so that there should be no significant difference with backward-mode. Finally, <code class="docutils literal notranslate"><span class="pre">local_constitutive_update</span></code> also returns <code class="docutils literal notranslate"><span class="pre">state</span></code> as an auxiliary output. This is specified explicitly with <code class="docutils literal notranslate"><span class="pre">has_aux=True</span></code> which indicates that the function returns a pair where the first element is considered the output of the mathematical function to be differentiated and the second element is auxiliary data. In this case, the output of <code class="docutils literal notranslate"><span class="pre">jacfwd</span></code> is <code class="docutils literal notranslate"><span class="pre">(jacobian,</span> <span class="pre">state)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tangent_operator_and_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">(</span>
    <span class="n">local_constitutive_update</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="jit-and-automatic-vectorization">
<h4>JIT and automatic vectorization<a class="headerlink" href="#jit-and-automatic-vectorization" title="Link to this heading">#</a></h4>
<p>Finally, we will later have to call this function when looping over all quadrature points. Implementing such a loop in pure Python would obviously be extremely inefficient. An alternative would be to rewrite the <code class="docutils literal notranslate"><span class="pre">local_constitutive_update</span></code> function in vectorized form to work on a batch of strain-like quantities of shape <code class="docutils literal notranslate"><span class="pre">(3,num_gauss)</span></code> where <code class="docutils literal notranslate"><span class="pre">num_gauss</span></code> is the total number of Gauss points. Although this is not particularly difficult to implement in the present case, it requires reimplementing the function which is error-prone and cumbersome in general. Fortunately, JAX provides a way to automatically transform a function into an efficient vectorized form using <code class="docutils literal notranslate"><span class="pre">jax.vmap</span></code>. Applying this vectorization to the <code class="docutils literal notranslate"><span class="pre">tangent_operator_and_state</span></code> function, we simply specify that the batch will take place over axis 0 of the first 3 arguments but not the last one (<code class="docutils literal notranslate"><span class="pre">dt</span></code> is not batched). Finally, the resulting function is also jitted for efficient compilation and execution by the XLA compiler.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batched_constitutive_update</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span>
    <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">tangent_operator_and_state</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="dolfinx-constitutive-update">
<h4><code class="docutils literal notranslate"><span class="pre">dolfinx</span></code> constitutive update<a class="headerlink" href="#dolfinx-constitutive-update" title="Link to this heading">#</a></h4>
<p>We are now ready to define a global constitutive update function on the <code class="docutils literal notranslate"><span class="pre">dolfinx</span></code> side. The latter will be called at each iteration of a global Newton method. It will first interpolate the current estimate of the total strain at all quadrature points. Arrays of strain increments and internal state variables are then passed to the <code class="docutils literal notranslate"><span class="pre">batched_constitutive_update</span></code> function which returns the batched tangent operator and state. Quadrature functions associated with the stress, tangent operator and new internal state variables are then updated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">constitutive_update</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">eps_old</span><span class="p">,</span> <span class="n">epsv_old</span><span class="p">,</span> <span class="n">epsv</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;Constitutive update&quot;</span><span class="p">):</span>
        <span class="n">eps_values</span> <span class="o">=</span> <span class="n">eval_at_quadrature_points</span><span class="p">(</span><span class="n">eps_expr</span><span class="p">)</span>
        <span class="n">eps_old_values</span> <span class="o">=</span> <span class="n">eps_old</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ngauss</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">deps_values</span> <span class="o">=</span> <span class="n">eps_values</span> <span class="o">-</span> <span class="n">eps_old_values</span>
        <span class="n">epsv_old_values</span> <span class="o">=</span> <span class="n">epsv_old</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ngauss</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Ct_values</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">batched_constitutive_update</span><span class="p">(</span>
            <span class="n">deps_values</span><span class="p">,</span> <span class="n">eps_old_values</span><span class="p">,</span> <span class="n">epsv_old_values</span><span class="p">,</span> <span class="n">dt</span>
        <span class="p">)</span>
        <span class="n">sig_values</span><span class="p">,</span> <span class="n">epsv_new_values</span> <span class="o">=</span> <span class="n">state</span>

        <span class="n">sig</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">sig_values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">epsv</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">epsv_new_values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">Ct</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Ct_values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="custom-newton-solver">
<h3>Custom Newton solver<a class="headerlink" href="#custom-newton-solver" title="Link to this heading">#</a></h3>
<p>We now define a custom Newton solver defined in the <a class="reference download internal" download="" href="../../../_downloads/1d9925fc2f3fd576a7ea5981d4bcdd4b/solvers.py"><code class="xref download docutils literal notranslate"><span class="pre">solvers.py</span></code></a> module. The solver first relies on a <code class="docutils literal notranslate"><span class="pre">CustomLinearProblem</span></code> which is the same custom <code class="docutils literal notranslate"><span class="pre">LinearProblem</span></code> implementation which was described in the <a class="reference internal" href="../plasticity/plasticity.html"><span class="std std-doc">Elasto-plastic analysis of a 2D von Mises material </span></a> demo. The latter works in particular with the iteration correction field <code class="docutils literal notranslate"><span class="pre">du</span></code> as the main unknown and solves the Newton system:</p>
<div class="math notranslate nohighlight">
\[[\mathbf{K}_\text{tang}]\{\delta U\} = -\{\text{Res}\}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tangent_problem</span> <span class="o">=</span> <span class="n">CustomLinearProblem</span><span class="p">(</span>
    <span class="n">tangent_form</span><span class="p">,</span>
    <span class="o">-</span><span class="n">Residual</span><span class="p">,</span>
    <span class="n">u</span><span class="o">=</span><span class="n">du</span><span class="p">,</span>
    <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span>
    <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pc_type&quot;</span><span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pc_factor_mat_solver_type&quot;</span><span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then, we define the <code class="docutils literal notranslate"><span class="pre">CustomNewtonSolver</span></code> which is a standard Newton method made for solving the previous system described in <code class="docutils literal notranslate"><span class="pre">tangent_problem</span></code>. The main difference is that such a solver implements a callback function <code class="docutils literal notranslate"><span class="pre">CustomNewtonSolver.callback</span></code> which takes as arguments the unknown field <code class="docutils literal notranslate"><span class="pre">u</span></code> and a list of other additional arguments. Here, the callback is provided to be the <code class="docutils literal notranslate"><span class="pre">constitutive_update</span></code> function defined earlier.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">newton</span> <span class="o">=</span> <span class="n">CustomNewtonSolver</span><span class="p">(</span><span class="n">tangent_problem</span><span class="p">)</span>
<span class="n">newton</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">constitutive_update</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="time-stepping-loop">
<h3>Time-stepping loop<a class="headerlink" href="#time-stepping-loop" title="Link to this heading">#</a></h3>
<p>We are now ready to define the time stepping loop and solve the nonlinear Newton system at each time increment. We will also monitor the average vertical strain and stress during the time evolution for postprocessing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Nincr</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">Nincr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nincr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># we set all functions to zero before entering the loop in case we would like to reexecute this code cell</span>
<span class="n">sig</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">epsv</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nincr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dti</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time_steps</span><span class="p">)):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">eps_old</span><span class="p">,</span> <span class="n">epsv_old</span><span class="p">,</span> <span class="n">epsv</span><span class="p">,</span> <span class="n">dti</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;Nonlinear solve&quot;</span><span class="p">):</span>
        <span class="n">niter</span><span class="p">,</span> <span class="n">converged</span> <span class="o">=</span> <span class="n">newton</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">converged</span><span class="p">,</span> <span class="s2">&quot;Solver did not converge.&quot;</span>

    <span class="c1"># Update the previous total and viscous strain</span>
    <span class="n">eps_old</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">eval_at_quadrature_points</span><span class="p">(</span><span class="n">eps_expr</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">epsv</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">epsv_old</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>

    <span class="c1"># Post-processing</span>
    <span class="n">epsv_values</span> <span class="o">=</span> <span class="n">epsv</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ngauss</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sig_values</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ngauss</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">results</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">epsv_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">results</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sig_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:jax._src.xla_bridge:No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Link to this heading">#</a></h2>
<p>We check that the solution we obtain corresponds to the exact solution of the recovery test given by:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
\epsv_{yy}(t) &amp;= \varepsilon_r(1- \exp(-t/\tau))\\
\sigma_{yy}(t) &amp;= E_0\varepsilon_r + E_1\varepsilon_r \exp(-t/\tau)
\end{align*}\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">E0</span> <span class="o">=</span> <span class="n">mat_prop</span><span class="p">[</span><span class="s2">&quot;YoungModulus&quot;</span><span class="p">]</span>
<span class="n">eta</span> <span class="o">=</span> <span class="n">mat_prop</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">]</span>
<span class="n">tau</span> <span class="o">=</span> <span class="n">mat_prop</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">]</span>
<span class="n">E1</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">/</span> <span class="n">tau</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">epsr</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">time_steps</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)),</span> <span class="s2">&quot;-C3&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Exact&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">results</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FEM&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time $t$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Viscous strain $\varepsilon_</span><span class="si">{yy}</span><span class="s2">^\text</span><span class="si">{v}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">epsr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">time_steps</span><span class="p">,</span> <span class="n">E0</span> <span class="o">*</span> <span class="n">epsr</span> <span class="o">+</span> <span class="n">E1</span> <span class="o">*</span> <span class="n">epsr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">time_steps</span> <span class="o">/</span> <span class="n">tau</span><span class="p">),</span> <span class="s2">&quot;-C3&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Exact&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">results</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FEM&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time $t$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Stress $\sigma_</span><span class="si">{yy}</span><span class="s2">$ [MPa]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/f153e15c6a323c5b9853c50b6754ed617049f9aff47c07e88c5e22431bc3735c.png" src="../../../_images/f153e15c6a323c5b9853c50b6754ed617049f9aff47c07e88c5e22431bc3735c.png" />
<img alt="../../../_images/62a7c2642c2016c5ced3245e818bb828c9288a3216af047b86ae51a891f5e339.png" src="../../../_images/62a7c2642c2016c5ced3245e818bb828c9288a3216af047b86ae51a891f5e339.png" />
</div>
</div>
<p>The FE solution matches indeed the exact solution as seen above. The instantaneous stress is <span class="math notranslate nohighlight">\(\sigma_{yy}(t=0^+) = (E_0+E_1)\varepsilon_r = 90\)</span> MPa whereas the long-term stress is given by <span class="math notranslate nohighlight">\(\sigma_{yy}(t=\infty) = E_0\varepsilon_r = 70\)</span> MPa.</p>
<p>Finally, we look at the timings to check that the call to the constitutive equation is negligible compared to the time spent solving global linear systems when problems are sufficiently large.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dolfinx</span> <span class="kn">import</span> <span class="n">common</span>

<span class="n">common</span><span class="o">.</span><span class="n">list_timings</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">TimingType</span><span class="o">.</span><span class="n">wall</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[MPI_MAX] Summary of timings                                                |  reps  wall avg  wall tot
-------------------------------------------------------------------------------------------------------
Build dofmap data                                                           |     5  0.000195  0.000973
Build sparsity                                                              |     1  0.000227  0.000227
Compute dof reordering map                                                  |     5  0.000011  0.000055
Compute entities of dim = 1                                                 |     1  0.000883  0.000883
Compute local part of mesh dual graph                                       |     1  0.000784  0.000784
Compute local-to-local map                                                  |     1  0.000100  0.000100
Compute-local-to-global links for global/local adjacency list               |     1  0.000015  0.000015
Constitutive update                                            
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             |   149  0.001957  0.291532
Distribute row-wise data (scalable)                                         |     1  0.000246  0.000246
GPS: create_level_structure                                                 |     2  0.000019  0.000039
Gibbs-Poole-Stockmeyer ordering                                             |     1  0.000159  0.000159
Init dofmap from element dofmap                                             |     5  0.000042  0.000209
Nonlinear solve                                                             |    50  0.047246  2.362288
SparsityPattern::finalize                                                   |     1  0.000285  0.000285
Topology: create                                                            |     1  0.003114  0.003114
Topology: determine shared index ownership                                  |     1  0.001745  0.001745
Topology: determine vertex ownership groups (owned, undetermined, unowned)  |     1  0.000244  0.000244
</pre></div>
</div>
</div>
</div>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<div class="docutils container" id="id2">
<div role="list" class="citation-list">
<div class="citation" id="id12" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">SHamalainen10</a><span class="fn-bracket">]</span></span>
<p>Joonas Sorvari and Jari Hämäläinen. Time integration in linear viscoelasticity—a comparative study. <em>Mechanics of Time-Dependent Materials</em>, 14:307–328, 2010.</p>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./tours/nonlinear_problems/linear_viscoelasticity_jax"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../plasticity/plasticity.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Elasto-plastic analysis of a 2D von Mises material <span class="far fa-star"></span><span class="far fa-star"></span><span class="far fa-star"></span></p>
      </div>
    </a>
    <a class="right-next"
       href="../bound_constrained/bound_constrained.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Localized 1D solutions in phase-field approach to brittle fracture <span class="far fa-star"></span><span class="far fa-star"></span></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nonlinear-constitutive-models-in-fenics">Nonlinear constitutive models in FEniCS</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#automation-and-high-performance-computation-using-jax">Automation and high-performance computation using JAX</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-viscoelastic-behavior">Linear viscoelastic behavior</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-rheological-formulation">1D rheological formulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-generalization">3D generalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-integration">Time-integration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-position">Problem position</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quadrature-functions">Quadrature functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-implementation-of-the-constitutive-equation">JAX implementation of the constitutive equation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#local-material-constitutive-behavior">Local material constitutive behavior</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tangent-operator-with-automatic-differentiation">Tangent operator with Automatic Differentiation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jit-and-automatic-vectorization">JIT and automatic vectorization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dolfinx-constitutive-update"><code class="docutils literal notranslate"><span class="pre">dolfinx</span></code> constitutive update</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-newton-solver">Custom Newton solver</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-stepping-loop">Time-stepping loop</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jeremy Bleyer
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>